<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign on Screen & View Signatures</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #signature-pad {
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
    }

    .controls {
      margin-top: 12px;
    }

    canvas {
      width: 100%;
      height: 200px;
      touch-action: none;
    }
    #toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1055;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <!-- Sign on screen section -->
    <h1>Sign on the Screen</h1>
    <p>Enter name and email, draw your signature, then press Save.</p>

    <div class="card p-3 mb-5">
      <div class="mb-3">
        <label class="form-label">Name</label>
        <input id="name" class="form-control" placeholder="Your full name">
      </div>

      <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="email" class="form-control" placeholder="you@example.com" type="email">
      </div>

      <div id="signature-pad" class="mb-2">
        <canvas id="canvas" width="600" height="200"></canvas>
      </div>

      <div class="controls d-flex gap-2 align-items-center">
        <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
        <button id="saveBtn" class="btn btn-primary">Save Signature</button>
        <span id="signature-count" class="ms-3 fw-bold">Total signatures: 0</span>
      </div>

      <div id="status" class="mt-3"></div>
    </div>

    <!-- Password-protected signature table -->
    <h1>Saved Signatures</h1>
    <div id="password-section" class="mb-3">
      <input type="password" id="password-input" class="form-control mb-2"
        placeholder="Enter password to view signatures">
      <button type="submit" id="submit-password" class="btn btn-primary">Submit</button>
    </div>

    <div id="signature-table-section" style="display:none;">
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Signature</th>
          </tr>
        </thead>
        <tbody id="signature-list"></tbody>
      </table>
    </div>
  </div>

  <div id="toast-container"></div>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/signature.js"></script>

  <script>
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const canvas = document.getElementById("canvas");
    const signaturePad = new SignaturePad(canvas);
    const statusDiv = document.getElementById("status");
    const signatureCountSpan = document.getElementById("signature-count");
    const signatureList = document.getElementById("signature-list");
    const submitBtn = document.getElementById("submit-password");
    const toastContainer = document.getElementById("toast-container");

    // Clear signature
    clearBtn.addEventListener("click", () => {
      signaturePad.clear();
    });

    // Update signature count
    function updateSignatureCount() {
      fetch('/api/signatures')
        .then(res => res.json())
        .then(signatures => {
          signatureCountSpan.textContent = `Total signatures: ${signatures.length}`;
        });
    }

    updateSignatureCount(); // Initial load

    // Show toast notification
    function showToast(message) {
      const toastEl = document.createElement("div");
      toastEl.className = "toast align-items-center text-bg-success border-0";
      toastEl.setAttribute("role", "alert");
      toastEl.setAttribute("aria-live", "assertive");
      toastEl.setAttribute("aria-atomic", "true");

      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      toastContainer.appendChild(toastEl);
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();

      // Remove toast from DOM after hidden
      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    // Save signature
    saveBtn.addEventListener("click", () => {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!name || !email || signaturePad.isEmpty()) {
        alert("Name, email, and signature are required!");
        return;
      }

      const signatureData = signaturePad.toDataURL("image/png");

      fetch('/api/signatures', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, signature: signatureData })
      })

        .then(async res => {
          const data = await res.json();

          // User tried to sign again -> DO NOT REFRESH TABLE
          if (res.status === 409) {
            alert("Name or Email already exists!");
            showToast("Duplicate! Cannot sign again.");
            return;
          }

          if (!res.ok) {
            alert(data.error || "Failed to save!");
            return;
          }

          // Success case only
          statusDiv.textContent = "Signature saved!";
          signaturePad.clear();
          updateSignatureCount();
          showToast(`Success! ${email} has signed.`);

          // Only refresh table if user is currently viewing it
          if (document.getElementById("signature-table-section").style.display === "block") {
            loadSignatures();
          }
        })


        .catch(err => {
          console.error(err);
          alert("Error saving signature");
        });
    });

    // Load signatures table
    function loadSignatures() {
      fetch('/api/signatures')
        .then(res => res.json())
        .then(signatures => {
          signatureList.innerHTML = '';
          signatures.forEach(sig => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${sig.name}</td>
              <td>${sig.email}</td>
              <td><img src="/uploads/${sig.filename}" width="200"></td>
            `;
            signatureList.appendChild(tr);
          });
        });
    }

    // Password protection
    submitBtn.addEventListener("click", () => {
      const password = document.getElementById("password-input").value;
      if (password === "dangote001") {
        document.getElementById("password-section").style.display = "none";
        document.getElementById("signature-table-section").style.display = "block";
        loadSignatures();
      } else {
        alert("Incorrect password!");
      }
    });
  </script>
</body>

</html>